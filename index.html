<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>
    <style>
        select.custom-select {
            height: 34px;
            font-size: 15px;
        }

        div.input-group-prepend {
            height: 34px;
            font-size: 15px;
        }

        input.form-control,
        select.custom-select {
            font-size: 18px;
            width: 500px;
            height: 40px;
        }

        label.input-group-text,
        span.input-group-text,
        .btn {
            height: 40px;
            ;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row justify-content-center">
            <form id="registerForm">
                <div class="row " style="justify-content: center;">
                    <div class="col">
                        <h1> Formulario de Registro</h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control user " placeholder="User" aria-label="User"
                                aria-describedby="btnUserCheck" id="inputUser" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="btnUserCheck"
                                    style=" border-bottom-right-radius: 3px; border-top-right-radius: 3px ; border: 1px solid #EED2CD;">Check</button>
                            </div>
                            <div class="user" style="height: 3px;"></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control sponsor" placeholder="Patrocinador"
                                aria-label="Patrocinador" aria-describedby="btnPatrocinadorCheck" id="inputPatrocinador"
                                required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="btnPatrocinadorCheck"
                                    style=" border-bottom-right-radius: 3px; border-top-right-radius: 3px ; border: 1px solid #EED2CD;">Check</button>
                            </div>
                            <div class="sponsor" style="height: 3px;"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Name" id="inputName" required>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Lastname" id="inputLastName" required>
                    </div>
                </div>

                <div class="row" style="margin-top: 15px;">
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupTDocumento">Tipo Documento</label>
                            </div>
                            <select class="custom-select" id="inputGroupTDocumento" required>
                                <option value="">Choose...</option>
                                <option value="Cedula">Cedula</option>
                                <option value="Pasaporte">Pasaporte</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <input type="number" placeholder="Numero de Documento" class="form-control"
                            id="inputNumDocumento" required>
                    </div>
                </div>

                <div class="row" style="margin-top: 15px;">
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="spanBirthday">Birthday</span>
                            </div>
                            <input type="date" class="form-control" aria-label="Birthday"
                                aria-describedby="spanBirthday" id="inputDateBirthday" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupGender">Gender</label>
                            </div>
                            <select class="custom-select" id="inputGroupGender" required>
                                <option value="">Choose...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="input-group mb-3" id="app">
                            <input type="text" class="form-control" placeholder="Email" aria-label="Email"
                                aria-describedby="btnSubmitEmail" id="inputEmail" v-model="from_email" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="btnSubmitEmail"
                                    @click="enviar"
                                    style=" border-bottom-right-radius: 3px; border-top-right-radius: 3px ; border: 1px solid #EED2CD;">Submit</button>
                            </div>
                            <div></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-3">
                            <input type="number" class="form-control" placeholder="Verify Email"
                                aria-label="Verify Email" aria-describedby="btnVerifyEmail" id="inputVerifyEmail"
                                required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="btnVerifyEmail"
                                    style=" border-bottom-right-radius: 3px; border-top-right-radius: 3px ; border: 1px solid #EED2CD;">Verify</button>
                            </div>
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <input type="password" class="form-control" placeholder="Password" id="inputPassword"
                            minlength="8" required>
                    </div>
                    <div class="col">
                        <input type="password" class="form-control" placeholder="Confirm Password"
                            id="inputConfirmPassword" minlength="8" required>
                    </div>
                </div>

                <div class="row" style="margin-top: 15px;">
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupTCuenta">Tipo Cuenta</label>
                            </div>
                            <select class="custom-select" id="inputGroupTCuenta" required>
                                <option value="">Choose...</option>
                                <option value="Ahorros">Ahorros</option>
                                <option value="Corriente">Corriente</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <input type="number" placeholder="Numero de Cuenta" class="form-control" id="inputNumCuenta"
                            required>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <input type="number" placeholder="Number" class="form-control" id="inputNumber" required>
                    </div>
                    <div class="col">
                        <input type="text" placeholder="Direccion" class="form-control" id="inputDireccion" required>
                    </div>
                </div>
                <br>

                <div class="row">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Departamento" id="inputState" required>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Ciudad" id="inputCity" required>
                    </div>
                </div>
                <br>

                <div class="row">
                    <div class="col">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="imageCedula" lang="es" required>
                            <label class="custom-file-label" for="imageCedula">Foto de la cedula (Frontal)</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="imageRespaldoCedula" lang="es" required>
                            <label class="custom-file-label" for="imageRespaldoCedula">Foto de la cedula
                                (Respaldo)</label>
                        </div>
                    </div>

                </div>
                <br>

                <div class="row">
                    <div class="col">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="imageSelfiDocumento" lang="es" required>
                            <label class="custom-file-label" for="imageSelfiDocumento">Selfi con la cedula</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" id="imageRecibo" lang="es" required>
                            <label class="custom-file-label" for="imageRecibo">Foto de recibo donde vive</label>
                        </div>
                    </div>
                </div>
                <br>

                <div class="row">
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupPlazo">Plazo</label>
                            </div>
                            <select class="custom-select" id="inputGroupPlazo" required>
                                <option value="">Choose...</option>
                                <option value="Corto Plazo">Corto Plazo</option>
                                <option value="Mediano Plazo">Mediano Plazo</option>
                                <option value="Largo Plazo">Largo Plazo</option>
                            </select>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <label class="input-group-text" for="inputGroupPlan">Plan</label>
                            </div>
                            <select class="custom-select" id="inputGroupPlan" required>
                                <option selected>Choose...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div  id="btnPago">
                </div>

                <div class="row">
                    <div class="col">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="customCheckTYC" required>
                            <label class="custom-control-label" for="customCheckTYC">Terminos y Condiciones</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="customCheckAuthData" required>
                            <label class="custom-control-label" for="customCheckAuthData">Autorizacion de datos</label>
                        </div>
                    </div>
                    <div class="col">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="customCheck1" required>
                            <label class="custom-control-label" for="customCheck1">Check this custom checkbox</label>
                        </div>
                    </div>
                </div>
                <br>

                <div class="row justify-content-center">
                    <button class="btn btn-primary btn-lg" id="btnSubmit" type="submit">Submit</button>
                </div>

            </form>
            <input type="text" id="inputExistData" style="display: none;">
            <div class="row justify-content-center">
                <button class="btn btn-primary btn-lg" id="btnSubmit2" type="button">Submit</button>
            </div>
        </div>
    </div>
</body>
<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>


<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js">
</script>

<script src="https://cdn.emailjs.com/dist/email.min.js" type="text/javascript">
</script>

<script>
    var firebaseConfig = {
        apiKey: "AIzaSyCPvLMdAYWqdYLAZK28AbBa56mIAo1JkxU",
        authDomain: "appfinancemarketscapital.firebaseapp.com",
        databaseURL: "https://appfinancemarketscapital.firebaseio.com",
        projectId: "appfinancemarketscapital",
        storageBucket: "gs://appfinancemarketscapital.appspot.com",
        messagingSenderId: "327823603780",
        appId: "1:327823603780:web:506199709abac99322a411",
        measurementId: "G-3V5TM2M89C"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();
    const dbStorage = firebase.storage().ref();

    const registerFrom = document.getElementById('registerForm');
    const existData = document.getElementById('inputExistData');
    const btnUserCheck = document.getElementById('btnUserCheck');
    const btnPatrocinadorCheck = document.getElementById('btnPatrocinadorCheck');
    const btnVerifyEmail = document.getElementById('btnVerifyEmail');
    const selectPlazo = document.getElementById('inputGroupPlazo');
    const selectPlan = document.getElementById('inputGroupPlan');
    const divBtnPago = document.getElementById('btnPago');
    const btnSubmit = document.getElementById('btnSubmit2');
    const divCheckUser = document.getElementsByClassName("user")[1];
    const inputUser = document.getElementsByClassName("user")[0];
    const divChecksponsor = document.getElementsByClassName("sponsor")[1];
    const inputsponsor = document.getElementsByClassName("sponsor")[0];

    let key = ''; //llave con la que se busca el registro
    let data = ''; // dato con la que se busca el registro
    let exist = ''; // determina si el registro existe
    let datos = ''; //Almacena la respuesta de la busqueda
    let numVerify; // numero de verificacion de email
    let plazo; // plazo del plan
    let plan;
    let filtro; // Filtro del plan
    let existUser = false;
    let existSponsor = false;
    let correoVerificado = false;


    const getUsers = () => db.collection('Users').get();
    const planes = (callback) => db.collection('Planes').doc('5popKkRNj8G6bnFLxF7m').collection(plazo).orderBy(filtro, "asc").onSnapshot(callback);
    const numRandom = () => Math.floor(Math.random() * (1000000 - 100000)) + 100000;

    function dataExist(key, data) {
        db.collection("Users").where(key, "==", data)
            .get()
            .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    datos = doc.data();
                    existData.value = datos[key];
                });
            })
            .catch(function (error) {
                console.log("Error getting documents: ", error);
            });
        setTimeout(waitDatos, 1000);
    }

    function waitDatos() {
        existData.value == '' ? exist = false : exist = true;
    }

    $(document).ready(function () {
        registerFrom['inputVerifyEmail'].disabled = true;
        btnVerifyEmail.disabled = true;

    });

    function saveDateUser(user, sponsor, name, lastname, tDocument, numDocument, birthday, gender, email, tAccount, numAccount, number, country, status, city) {
        db.collection('Users').doc().set({
            user, sponsor, name, lastname, tDocument, birthday, gender, email, tAccount, numAccount, number, country, state, city, numDocument
        });
    }

    function waitUser() {
        existUser = exist;
        existData.value = '';
        exist = '';
        datos = '';
        if (existUser) {
            inputUser.className = '';
            divCheckUser.className = '';
            divCheckUser.innerHTML = '';
            inputUser.className += 'form-control is-invalid user';
            divCheckUser.className += 'user invalid-feedback';
            divCheckUser.innerHTML += '<p>Escoge otro nombre de usuario</p>';
        } else {
            inputUser.className = '';
            divCheckUser.className = '';
            divCheckUser.innerHTML = '';
            inputUser.className += 'form-control is-valid user';
            divCheckUser.className += 'user valid-feedback';
            divCheckUser.innerHTML += '<p>Este usuario esta disponible</p>';
        }
    }

    function waitSponsor() {
        existSponsor = exist;
        if (existSponsor) {
            inputsponsor.className = '';
            divChecksponsor.className = '';
            divChecksponsor.innerHTML = '';
            inputsponsor.className += 'form-control is-valid sponsor';
            divChecksponsor.className += 'sponsor valid-feedback';
            divChecksponsor.innerHTML += '<p>' + datos['name'] + ' ' + datos['lastname'] + '</p>';
            
        } else {
            inputsponsor.className = '';
            divChecksponsor.className = '';
            divChecksponsor.innerHTML = '';
            inputsponsor.className += 'form-control is-invalid sponsor';
            divChecksponsor.className += 'sponsor invalid-feedback';
            divChecksponsor.innerHTML += '<p>El patrocinador no existe</p>';
        }
        existData.value = '';
        exist = '';
        datos = '';
    }

    function confirPassword(){
        if(registerFrom['inputPassword'].value == registerFrom['inputConfirmPassword'].value){
            return true;
        }else{
            return false;
        }
    }

    function hashPassword(){
            let passwordHash = CryptoJS.MD5(registerFrom['inputPassword'].value);
            return passwordHash;
    }

    btnUserCheck.addEventListener('click', async (e) => {
        await dataExist("user", registerFrom['inputUser'].value);
        setTimeout(waitUser, 2000);
    });

    btnPatrocinadorCheck.addEventListener('click', async (e) => {
        await dataExist("user", registerFrom['inputPatrocinador'].value);
        setTimeout(waitSponsor, 2000);
        existData.value = '';
        exist = '';
        datos = '';
    });

    btnVerifyEmail.addEventListener('click', (e) => {
        if (numVerify == registerFrom['inputVerifyEmail'].value) {
            alert('los numeros coinciden');
            registerFrom['inputVerifyEmail'].disabled = true;
            btnVerifyEmail.disabled = true;
        } else {
            alert('los numeros no coinciden');
        }
    });

    btnSubmit.addEventListener('click', (e)=>{
        console.log(existSponsor,existUser,correoVerificado);
        if( !existUser&&existSponsor&&correoVerificado){
            return true;
         }else{
            return false;
         }
         
    })

    selectPlazo.addEventListener('change', async (e) => {
        plazo = registerFrom['inputGroupPlazo'].value;
        if (plazo == 'Largo Plazo') {
            filtro = "meses";
        } else {
            filtro = "porcentaje";
        }
        selectPlan.innerHTML = '<option selected>Choose...</option>';
        await planes((querySnapshot) => {
            querySnapshot.forEach(doc => {
                plan = doc.data();
                selectPlan.innerHTML += '<option value="' + plan['nombre'] + '">' + plan['nombre'] + '</option>'
            });
        });
    });

    selectPlan.addEventListener('change', (e) => {
        let dat;
        db.collection('Planes').doc('5popKkRNj8G6bnFLxF7m').collection(plazo).where("nombre", "==", selectPlan.value)
            .get()
            .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                    dat = doc.data();
                    divBtnPago.innerHTML = '';
                    divBtnPago.innerHTML += '<div class="row justify-content-center"><div class="col">'+
                                            '<div class="alert alert-success" role="alert" >'+
                                            '<h4 class="alert-heading">Plan a '+  plazo  +'</h4>'+
                                            '<p>Estas a punto de adquirir un '+ dat['nombre'] +' a '+ plazo +', el porcentaje de ganacia es '+  dat['porcentaje']  +'% al mes y una permanencia de '+ dat['retiro'] +'</p>'
                                            ' <hr>'+
                                            '<p class="mb-0">Whenever you need to, be sure to use margin utilities to keep things nice and tidy.</p></div></div><br>';
                    divBtnPago.innerHTML += '<div class="row justify-content-center"><a href="' + dat['linkPago'] + '" class="btn btn-warning" style="width: 400px; height: 40px;" target="_blank"> Pagar  </a></div><br>';
                });
            })
            .catch(function (error) {
                console.log("Error getting documents: ", error);
            });
    });

    registerFrom.addEventListener('submit', async (e) => {
        e.preventDefault();
        user = registerFrom['inputUser'].value;
        sponsor = registerFrom['inputPatrocinador'].value;
        name = registerFrom['inputName'].value;
        lastname = registerFrom['inputLastName'].value;
        tDocument = registerFrom['inputGroupTDocumento'].value;
        numDocument = registerFrom['inputNumDocumento'].value;
        birthday = registerFrom['inputDateBirthday'].value;
        gender = registerFrom['inputGroupGender'].value;
        email = registerFrom['inputEmail'].value;
        tAccount = registerFrom['inputGroupTCuenta'].value;
        numAccount = registerFrom['inputNumCuenta'].value;
        number = registerFrom['inputNumber'].value;
        country = registerFrom['inputGroupCountry'].value;
        state = registerFrom['inputState'].value;
        city = registerFrom['inputCity'].value;

        //await saveDateUser(user,sponsor,name,lastname,tDocument,numDocument,birthday,gender,email,tAccount,numAccount,number, country,status,city);
    });

</script>

<script>
    (function () {
        emailjs.init("user_USX4M3dWIjUrxE8B3FICN");
    })();
    const vue = new Vue({
        el: '#app',
        data() {
            return {
                from_name: '',
                from_email: '',
                message: '',
                subject: '',
            }
        },
        methods: {
            async enviar() {

                numVerify = numRandom();
                let data = {
                    from_name: registerFrom['inputName'].value + ' ' + registerFrom['inputLastName'].value,
                    from_email: registerFrom['inputEmail'].value,
                    message: numVerify,
                    subject: "Verificacion de correo",
                };
                await dataExist("email", registerFrom['inputEmail'].value);
                setTimeout(function () {
                    if (exist) {
                        alert('El correo ingresado ya ha sido Registrado');
                        correoVerificado = false;
                        exist = '';
                    } else {
                        registerFrom['inputVerifyEmail'].disabled = false;
                        btnVerifyEmail.disabled = false;
                        emailjs.send("service_rzi8owg", "template_ezx2066", data)
                            .then(function (response) {
                                if (response.text === 'OK') {
                                    alert('El correo se ha enviado de forma exitosa');
                                    correoVerificado = true;
                                    exist = '';
                                }
                                console.log("SUCCESS. status=%d, text=%s", response.status, response.text);
                            }, function (err) {
                                alert('Ocurrió un problema al enviar el correo');
                                console.log("FAILED. error=", err);
                            });
                    }
                }, 4000);


            }
        }
    });
</script>

<script>
 //const inputFile = document.getElementById('inputFile');

// const imag = document.getElementById('images');
// let fileList;
// inputFile.addEventListener('change', loadImage, false);
// function loadImage() {
////  fileList = this.files[0];
////  let loadImages = dbStorage.child('cedulas/' + "imagendewhatsapp").put(fileList);
////  loadImages.on('state_changed', function (snapshot) {
////////// Observe state change events such as progress, pause, and resume
////////// Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
////////var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
////////console.log('Upload is ' + progress + '% done');
////////switch (snapshot.state) {
////////// case firebase.storage.TaskState.PAUSED: // or 'paused'
////////////  console.log('Upload is paused');
////////////  break;
////////// case firebase.storage.TaskState.RUNNING: // or 'running'
////////////  console.log('Upload is running');
////////////  break;
////////}
////  }, function (error) {
////////// Handle unsuccessful uploads
////  }, function () {
////////// Handle successful uploads on complete
////////// For instance, get the download URL: https://firebasestorage.googleapis.com/...
////////loadImages.snapshot.ref.getDownloadURL().then(function (downloadURL) {
////////// console.log('File available at', downloadURL);
////////// imag.innerHTML = '<img src="' + downloadURL + '">';

////////});
////  });
 //   }


</script>

</html>