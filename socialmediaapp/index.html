<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

</head>

<body>
  <div class="container" style="margin-top: 10px;">
    <div class="table-responsive">
      <table id="tableUsers" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th class="th-sm">Nombre
            </th>
            <th class="th-sm">Apellido
            </th>
            <th class="th-sm"># Documento
            </th>
            <th class="th-sm">Patrocinador
            </th>
            <th class="th-sm">Novedad de pago
            </th>
            <th class="th-sm">Fecha Pago
            </th>
            <th class="th-sm"># Recibo
            </th>
            <th class="th-sm">Ver Usuario
            </th>
          </tr>
        </thead>
        <tbody id="myTable">
        </tbody>
        <tfoot>
          <tr>
            <th>Nombre
            </th>
            <th>Apellido
            </th>
            <th># Documento
            </th>
            <th>Patrocinador
            </th>
            <th>Novedad de pago
            </th>
            <th>Fecha Pago
            </th>
            <th># Recibo
            </th>
            <th>Ver Usuario
            </th>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="" style="margin-top: 20px; margin-bottom: 40px; display: none;  " id="containerUserForm">
      <div class="row col-md-12  justify-content-center">
        <div class="card text-center">
          <div class="card-header">
            <h4 style="
            font-size: 20px;
            margin-bottom: 0px;
            margin-top: 0px;
        ">Perfil de Usuario</h4>
          </div>
          <div class="card-body">
            <form class="col-md-12" id="formUser">
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Nombre Completo</span>
                    <input type="text" class="form-control" id="inputName" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="spanTipoDoc"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Cedula</span>
                    <input type="text" class="form-control" id="inputTipoDoc" aria-describedby="spanTipoDoc" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Representante</span>
                    <input type="text" class="form-control" id="inputRepresentante" aria-describedby="basic-addon3"
                      value="" disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Correo Electronico</span>
                    <input type="text" class="form-control" id="inputEmail" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Fecha Registro</span>
                    <input type="text" class="form-control" id="inputDateRegister" aria-describedby="basic-addon3"
                      value="" disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Número</span>
                    <input type="text" class="form-control" id="inputNumber" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablePlan" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                  <thead>
                    <tr>
                      <th class="th-sm">Plazo
                      </th>
                      <th class="th-sm">Plan
                      </th>
                      <th class="th-sm">Fecha compra
                      </th>
                      <th class="th-sm">Ver Recibo
                      </th>
                    </tr>
                  </thead>
                  <tbody id="tablePlanes">
                  </tbody>
                  <tr>
                    <th>Plazo
                    </th>
                    <th>Plan
                    </th>
                    <th>Fecha compra
                    </th>
                    <th>Ver Recibo
                    </th>
                  </tr>
                  <tfoot>
                  </tfoot>
                </table>
              </div>
              <div class="row justify-content-center" style="margin-top: 30px; margin-left: -35px;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="btn-group me-2 " role="group" aria-label="Second group">
                    <button type="button" class="btn btn-secondary btn-sm" id="btnDocument">Documento</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="btnRespaldo">Respaldo</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="btnSelfie">Selfie</button>
                    <button type="button" class="btn btn-secondary btn-sm" id="btnRecibo">Recibo Domicilio</button>
                  </div>
                </div>
              </div>
              <div class="row justify-content-center" style="margin-top: 20px;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol1">
                    <label class="form-check-label" for="flexRadioRol1">
                      Usuario
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol2">
                    <label class="form-check-label" for="flexRadioRol2">
                      Inversionista
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol3">
                    <label class="form-check-label" for="flexRadioRol3">
                      Representante
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol4">
                    <label class="form-check-label" for="flexRadioRol4">
                      Financiero
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol5">
                    <label class="form-check-label" for="flexRadioRol5">
                      Juridico
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol6">
                    <label class="form-check-label" for="flexRadioRol6">
                      Comercial
                    </label>
                  </div>
                </div>
              </div>
              <div class="row justify-content-center" style="margin-top: 20px;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioStatus" id="flexRadioStatus1">
                    <label class="form-check-label" for="flexRadioStatus1">
                      Activo
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="flexRadioStatus" id="flexRadioStatus2">
                    <label class="form-check-label" for="flexRadioStatus2">
                      Inactivo
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="card-footer text-muted">
            <div class="row justify-content-center">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                <button type="button" class="btn btn-warning" id="btnCerrar">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  </div>
</body>
<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js">
</script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCPvLMdAYWqdYLAZK28AbBa56mIAo1JkxU",
    authDomain: "appfinancemarketscapital.firebaseapp.com",
    databaseURL: "https://appfinancemarketscapital.firebaseio.com",
    projectId: "appfinancemarketscapital",
    storageBucket: "gs://appfinancemarketscapital.appspot.com",
    messagingSenderId: "327823603780",
    appId: "1:327823603780:web:506199709abac99322a411",
    measurementId: "G-3V5TM2M89C"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const db = firebase.firestore();
  const dbStorage = firebase.storage().ref();

  $(document).ready(function () {
    getUsers();
    setTimeout(function () {
      //$('#tableUsers').destroy();
      $('#tableUsers').DataTable({
        "language": {
          "url": "//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json"
        }
      });
    }, 2000);
  });

  const tableUsers = document.getElementById('myTable');
  const tablePlanes = document.getElementById('tablePlanes');
  const tableData = document.getElementById('tableUsers');
  const btnPrueba = document.getElementById('btnPrueba');
  const containerUserForm = document.getElementById('containerUserForm');
  const onGetUsers = (callback) => db.collection("Users").orderBy("fechaRegistro", "desc").onSnapshot(callback);
  const updateUser = (id, updateUser) => db.collection('Users').doc(id).update(updateUser);
  const getUser = (id) => db.collection("Users").doc(id).get();
  const formUser = document.getElementById('formUser');
  const btnCerrar = document.getElementById('btnCerrar');
  const btGuardar = document.getElementById('btGuardar');
  const btnDocument = document.getElementById('btnDocument');
  const btnRespaldo = document.getElementById('btnRespaldo');
  const btnSelfie = document.getElementById('btnSelfie');
  const btnRecibo = document.getElementById('btnRecibo');
  const flexRadioRol1 = document.getElementById('flexRadioRol1');
  const flexRadioRol2 = document.getElementById('flexRadioRol2');
  const flexRadioRol3 = document.getElementById('flexRadioRol3');
  const flexRadioRol4 = document.getElementById('flexRadioRol4');
  const flexRadioRol5 = document.getElementById('flexRadioRol5');
  const flexRadioRol6 = document.getElementById('flexRadioRol6');
  const flexRadioStatus1 = document.getElementById('flexRadioStatus1');
  const flexRadioStatus2 = document.getElementById('flexRadioStatus2');
  let referencia;
  let idUser;

  function getUsers() {
    onGetUsers((querySnapshot) => {
      tableUsers.innerHTML = '';
      querySnapshot.forEach(doc => {

        let data = doc.data();
        let datos;
        if (data['estado']) {
          db.collection("PlanesUsuarios").where('numerodocumento', "==", data['numerodocumento'])
            .get()
            .then(function (querySnapshot) {
              querySnapshot.forEach(function (dat) {
                datos = dat.data();
              });
            })
            .catch(function (error) {
              console.log("Error getting documents: ", error);
            });
          setTimeout(function () {
            tableUsers.innerHTML += '<tr> <td>' + data['nombre'] + '</td><td>' + data['apellido'] + '</td><td>' + data['numerodocumento'] + '</td><td>' + data['patrocinador'] + '</td><td>' + datos['estadoPago'] + '</td><td>' + datos['fechaPago'] + '</td><td>' + datos['recibo'] + '</td> <td><button class ="btn btn-primary  btnSearchUser" data-id = "' + doc.id + '">Ver Usuario</button></td> </tr>';
            const btnSearchUser = document.querySelectorAll('.btnSearchUser');
            btnSearchUser.forEach(btn => {
              btn.addEventListener('click', async (e) => {
                containerUserForm.style.display = "block";
                const doc = await getUser(e.target.dataset.id);
                let user = doc.data();
                let planes;
                idUser = doc.id;
                showUser(user);
                db.collection("PlanesUsuarios").where('numerodocumento', "==", user['numerodocumento'])
                  .get()
                  .then(function (querySnapshot) {
                    querySnapshot.forEach(function (dat) {
                      planes = dat.data();
                      //planes['referencia'] == 'Pendiente' ? btnReciboPago.disabled = true : btnReciboPago.disabled = false;
                    });
                  })
                  .catch(function (error) {
                    console.log("Error getting documents: ", error);
                  });
                setTimeout(function () {
                  tablePlanes.innerHTML = '';
                  tablePlanes.innerHTML += '<tr><td>' + planes['termino'] + '</td><td>' + planes['plan'] + '</td><td>' + planes['fechaPago'] + '</td> <td><button class ="btn btn-secondary  btnSearchRecibo" data-image = "' + user['numerodocumento'] + planes['referencia'] + '">Ver Recibo</button></td></tr>';
                  const btnSearchRecibo = document.querySelectorAll('.btnSearchRecibo');
                  btnSearchRecibo.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                      e.preventDefault();
                      getUrlImage('reciboPago' + e.target.dataset.image);
                    });
                  });
                  referencia = planes['referencia'];
                }, 1000);

              });
            });
          }, 1000);

        }
      });

    });
  }



  btnCerrar.addEventListener('click', function () {
    containerUserForm.style.display = "none";
    formUser.reset();
    tablePlanes.innerHTML = '';
  });

  btnDocument.addEventListener('click', (e) => {
    getUrlImage('cedula' + formUser['inputTipoDoc'].value);
  });

  btnRespaldo.addEventListener('click', (e) => {
    getUrlImage('Respaldocedula' + formUser['inputTipoDoc'].value);
  });

  btnSelfie.addEventListener('click', (e) => {
    getUrlImage('selfi' + formUser['inputTipoDoc'].value);
  });

  btnRecibo.addEventListener('click', (e) => {
    getUrlImage('recibo' + formUser['inputTipoDoc'].value);
  });

  flexRadioRol1.addEventListener('change', (e) => {
    updateRol('usuario');
  });

  flexRadioRol2.addEventListener('change', (e) => {
    updateRol('inversionista');
  });

  flexRadioRol3.addEventListener('change', (e) => {
    updateRol('representante');
  });

  flexRadioRol4.addEventListener('change', (e) => {
    updateRol('financiero');
  });

  flexRadioRol5.addEventListener('change', (e) => {
    updateRol('juridico');
  });

  flexRadioRol6.addEventListener('change', (e) => {
    updateRol('comercial');
  });

  flexRadioStatus1.addEventListener('change', (e) => {
    updateStatus(true);
  });

  flexRadioStatus2.addEventListener('change', (e) => {
    updateStatus(false);
  });



  function updateRol(rol) {
    updateUser(idUser, {
      rol: rol
    });
  }
  function updateStatus(status) {
    updateUser(idUser, {
      estado: status
    });
  }

  function rolUser(rol) {
    if (rol == 'usuario') {
      $('#flexRadioRol1').prop("checked", true);
    }
    if (rol == 'inversionista') {
      $('#flexRadioRol2').prop("checked", true);
    }
    if (rol == 'representante') {
      $('#flexRadioRol3').prop("checked", true);
    }
    if (rol == 'financiero') {
      $('#flexRadioRol4').prop("checked", true);
    }
    if (rol == 'juridico') {
      $('#flexRadioRol5').prop("checked", true);
    }
    if (rol == 'comercial') {
      $('#flexRadioRol6').prop("checked", true);
    }
  }

  function statusUser(status) {
    if (status == true) {
      $('#flexRadioStatus1').prop("checked", true);
    }
    if (status == false) {
      $('#flexRadioStatus2').prop("checked", true);
    }
  }

  function showUser(user) {
    formUser['inputName'].value = user['nombre'] + ' ' + user['apellido'];
    $('#spanTipoDoc').text(user['tipodocumento']);
    formUser['inputTipoDoc'].value = user['numerodocumento'];
    formUser['inputRepresentante'].value = user['patrocinador'];
    formUser['inputEmail'].value = user['correo'];
    formUser['inputDateRegister'].value = user['fechaRegistro'];
    formUser['inputNumber'].value = user['numero'];
    rolUser(user['rol']);
    statusUser(user['estado']);
  }

  function getUrlImage(nameImage) {
    let token = "";
    $.ajax({
      url: "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage,
      type: "GET",
      success: function(data){
        token = data.downloadTokens;
        urli = "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage + "?alt=media&token=" + token;
        window.open(urli, "Diseño Web");
      },
      error: function (){
        alert('No hay un recibo para este portafolio');
      }
    });
  }


</script>



</html>