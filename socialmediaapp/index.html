<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>


</head>

<body>
  <div class="container" style="margin-top: 10px;">
    <div class="table-responsive">
      <table id="tableUsers" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th class="th-sm">Nombre
            </th>
            <th class="th-sm">Apellido
            </th>
            <th class="th-sm"># Documento
            </th>
            <th class="th-sm">Representante
            </th>
            <th class="th-sm">Novedad de pago
            </th>
            <th class="th-sm">Fecha Pago
            </th>
            <th class="th-sm"># Recibo
            </th>
            <th class="th-sm">Ver Usuario
            </th>
          </tr>
        </thead>
        <tbody id="myTable">
        </tbody>
        <tfoot>
          <tr>
            <th>Nombre
            </th>
            <th>Apellido
            </th>
            <th># Documento
            </th>
            <th>Representante
            </th>
            <th>Novedad de pago
            </th>
            <th>Fecha Pago
            </th>
            <th># Recibo
            </th>
            <th>Ver Usuario
            </th>
          </tr>
        </tfoot>
      </table>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="modalAuth" tabindex="-1" aria-labelledby="modalAuthLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAuthLabel">Autorizar Cambios</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="formLogIn">
              <div class="row">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="input-group mb-3">
                    <input type="text" placeholder="Usuario" class="form-control" id="inputUser" required>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="input-group mb-3">
                    <input type="password" name="password" id="inputPassword" placeholder="Contraseña"
                      class="form-control" required>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="input-group mb-3 justify-content-center">
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                  </div>
                </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="" style="margin-top: 20px; margin-bottom: 40px; display: none;  " id="containerUserForm">
    <div class="row col-md-12  justify-content-center">
      <div class="card text-center">
        <div class="card-header">
          <h4 style="
            font-size: 20px;
            margin-bottom: 0px;
            margin-top: 0px;
        ">Perfil de Usuario</h4>
        </div>
        <div class="card-body">
          <form class="col-md-12" id="formUser">
            <div class="row " style="text-align: center;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Nombre Completo</span>
                  <input type="text" class="form-control" id="inputName" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="spanTipoDoc"
                    style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Cedula</span>
                  <input type="text" class="form-control" id="inputTipoDoc" aria-describedby="spanTipoDoc" value=""
                    disabled>
                </div>
              </div>
            </div>
            <div class="row " style="text-align: center;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Usuario</span>
                  <input type="text" class="form-control" id="inputUsuario" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">ID Referido</span>
                  <input type="text" class="form-control" id="inputIdReferido" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
            </div>
            <div class="row " style="text-align: center;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Representante</span>
                  <input type="text" class="form-control" id="inputRepresentante" aria-describedby="basic-addon3"
                    value="" disabled>
                </div>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Referido por</span>
                  <input type="text" class="form-control" id="inputRefPor" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
            </div>
            <div class="row " style="text-align: center;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Número</span>
                  <input type="text" class="form-control" id="inputNumber" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Correo Electronico</span>
                  <input type="text" class="form-control" id="inputEmail" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
            </div>
            <div class="row " style="text-align: center;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Fecha Registro</span>
                  <input type="text" class="form-control" id="inputDateRegister" aria-describedby="basic-addon3"
                    value="" disabled>
                </div>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                <div class="input-group mb-3">
                  <span class="input-group-text" id="basic-addon3"
                    style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Ciudad</span>
                  <input type="text" class="form-control" id="inputCiudad" aria-describedby="basic-addon3" value=""
                    disabled>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <div class="row">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <h3 class="titleTable">Portafolios Adquiridos</h3>
                </div>
              </div>
              <div class="row">
                <div class="col col-md-8 col-12 col-sm-12 col-lg-6 col-xl-6">
                  <h3 class="titleTable">Sumatoria Portafolios Adquiridos:</h3>
                </div>
                <div class="col col-md-4 col-12 col-sm-12 col-lg-6 col-xl-6" id="spaPorAd">
                </div>
              </div>
              <table id="tablePlan" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                <thead>
                  <tr>
                    <th>Plazo
                    </th>
                    <th>Plan
                    </th>
                    <th>Fecha compra
                    </th>
                    <th>Valor
                    </th>
                    <th>Número <br> de <br> Contrato
                    </th>
                    <th>Comprobante <br> de <br> Depósito
                    </th>
                    <th>Ver <br> Comprobante
                    </th>
                    <th>Estado <br> (Activo/Inactivo)
                    </th>
                  </tr>
                </thead>
                <tbody id="tablePlanes">
                </tbody>
                <tr>
                  <th>Plazo
                  </th>
                  <th>Plan
                  </th>
                  <th>Fecha compra
                  </th>
                  <th>Valor
                  </th>
                  <th>Número <br> de <br> Contrato
                  </th>
                  <th>Comprobante <br> de <br> Depósito
                  </th>
                  <th>Ver <br> Comprobante
                  </th>
                  <th>Estado <br> (Activo/Inactivo)
                  </th>
                </tr>
                <tfoot>
                </tfoot>
              </table>
            </div>
            <div class="row justify-content-center">
              <div class="col col-md-6 col-6 col-sm-6 col-lg-6 col-xl-3">
                <button type="button" class="btn btnArchivos " id="btnDocument">
                  <img
                    src="https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/icons%2FIcono1.png?alt=media&token=1b575199-cae2-48fd-8cf3-587a34569916"
                    style="height: 100px; width: 100px; margin: auto;"><br>
                  <span>Documento</span>
                </button>
              </div>
              <div class="col col-md-6 col-6 col-sm-6 col-lg-6 col-xl-3">
                <button type="button" class="btn btnArchivos" id="btnRespaldo">
                  <img
                    src="https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/icons%2FIcono2.png?alt=media&token=31f386c4-8f82-4a4c-9a1d-1f54f89b50bc"
                    style="height: 100px; width: 100px; margin: auto;"><br>
                  <span>Reverso</span>
                </button>
              </div>
              <div class="col col-md-6 col-6 col-sm-6 col-lg-6 col-xl-3">
                <button type="button" class="btn btnArchivos" id="btnSelfie">
                  <img
                    src="https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/icons%2FIcono3.png?alt=media&token=3203c757-c5d9-4d6e-8b98-f5dd84841b3c"
                    style="height: 100px; width: 100px; margin: auto;"><br>
                  <span>Foto</span>
                </button>
              </div>
              <div class="col col-md-6 col-6 col-sm-6 col-lg-6 col-xl-3">
                <button type="button" class="btn btnArchivos" id="btnRecibo">
                  <img
                    src="https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/icons%2Ficono4.png?alt=media&token=c3448692-2121-45a2-9e92-637916af2bff"
                    style="height: 100px; width: 100px; margin: auto;"><br>
                  <span>Domicilio</span>
                </button>
              </div>
            </div>
            <div class="row justify-content-center" style="margin-top: 20px;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol1">
                  <label class="form-check-label" for="flexRadioRol1">
                    Usuario
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol2">
                  <label class="form-check-label" for="flexRadioRol2">
                    Inversionista
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol3">
                  <label class="form-check-label" for="flexRadioRol3">
                    Representante
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol4">
                  <label class="form-check-label" for="flexRadioRol4">
                    Financiero
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol5">
                  <label class="form-check-label" for="flexRadioRol5">
                    Juridico
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioRol" id="flexRadioRol6">
                  <label class="form-check-label" for="flexRadioRol6">
                    Comercial
                  </label>
                </div>
              </div>
            </div>
            <div class="row justify-content-center" style="margin-top: 20px;">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioStatus" id="flexRadioStatus1">
                  <label class="form-check-label" for="flexRadioStatus1">
                    Activo
                  </label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="flexRadioStatus" id="flexRadioStatus2">
                  <label class="form-check-label" for="flexRadioStatus2">
                    Inactivo
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="card-footer text-muted">
          <div class="row justify-content-center">
            <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
              <!-- Button trigger modal -->
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAuth">
                Guardar datos
              </button>
              <button type="button" class="btn btn-warning" id="btnCerrar">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6">
          <div class="table-responsive" style="margin-top: 30px;">
            <div class="row">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6">
                <h3 class="titleTable">Referidos Directos</h3>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6" id="spaDirectos">
              </div>
            </div>
            <table id="tableRefDirectos" class="table table-striped table-bordered table-sm" cellspacing="0"
              width="100%">
              <thead>
                <tr>
                  <th class="th-sm">Id Referido
                  </th>
                  <th class="th-sm">Valor SPA
                  </th>
                </tr>
              </thead>
              <tbody id="tableRefDirect">
              </tbody>
              <tr>
                <th>Id Referido
                </th>
                <th>Valor SPA
                </th>
              </tr>
              <tfoot>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6">
          <div class="table-responsive" style="margin-top: 30px;">
            <div class="row">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6">
                <h3 class="titleTable">Referidos Indirectos</h3>
              </div>
              <div class="col col-md-12 col-12 col-sm-12 col-lg-6 col-xl-6" id="spaIndirectos">
              </div>
            </div>
            <table id="tableRefIndirectos" class="table table-striped table-bordered table-sm" cellspacing="0"
              width="100%">
              <thead>
                <tr>
                  <th class="th-sm">Id Referido
                  </th>
                  <th class="th-sm">Valor SPA
                  </th>
                </tr>
              </thead>
              <tbody id="tableRefInirect">
              </tbody>
              <tr>
                <th>Id Referido
                </th>
                <th>Valor SPA
                </th>
              </tr>
              <tfoot>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
      crossorigin="anonymous"></script>

</body>

<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js">
</script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCPvLMdAYWqdYLAZK28AbBa56mIAo1JkxU",
    authDomain: "appfinancemarketscapital.firebaseapp.com",
    databaseURL: "https://appfinancemarketscapital.firebaseio.com",
    projectId: "appfinancemarketscapital",
    storageBucket: "gs://appfinancemarketscapital.appspot.com",
    messagingSenderId: "327823603780",
    appId: "1:327823603780:web:506199709abac99322a411",
    measurementId: "G-3V5TM2M89C"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const db = firebase.firestore();
  const dbStorage = firebase.storage().ref();

  $(document).ready(function () {
    getUsers();
    setTimeout(function () {
      //$('#tableUsers').destroy();
      $('#tableUsers').DataTable({
        "language": {
          "url": "//cdn.datatables.net/plug-ins/1.10.15/i18n/Spanish.json"
        }
      });
    }, 2000);
  });

  const tableUsers = document.getElementById('myTable');
  const tablePlanes = document.getElementById('tablePlanes');
  const tableData = document.getElementById('tableUsers');
  const btnPrueba = document.getElementById('btnPrueba');
  const containerUserForm = document.getElementById('containerUserForm');
  const onGetUsers = (callback) => db.collection("Users").orderBy("fechaRegistro", "desc").onSnapshot(callback);
  const updateUser = (id, updateUser) => db.collection('Users').doc(id).update(updateUser);
  const getUser = (id) => db.collection("Users").doc(id).get();
  //funcion de obtener datos
  const getDataByData = (document, type, data) => db.collection(document).where(type, "==", data).get();
  const formUser = document.getElementById('formUser');
  const formLogIn = document.getElementById('formLogIn');
  const btnCerrar = document.getElementById('btnCerrar');
  const btGuardar = document.getElementById('btGuardar');
  const btnDocument = document.getElementById('btnDocument');
  const btnRespaldo = document.getElementById('btnRespaldo');
  const btnSelfie = document.getElementById('btnSelfie');
  const btnRecibo = document.getElementById('btnRecibo');
  const flexRadioRol1 = document.getElementById('flexRadioRol1');
  const flexRadioRol2 = document.getElementById('flexRadioRol2');
  const flexRadioRol3 = document.getElementById('flexRadioRol3');
  const flexRadioRol4 = document.getElementById('flexRadioRol4');
  const flexRadioRol5 = document.getElementById('flexRadioRol5');
  const flexRadioRol6 = document.getElementById('flexRadioRol6');
  const flexRadioStatus1 = document.getElementById('flexRadioStatus1');
  const flexRadioStatus2 = document.getElementById('flexRadioStatus2');
  let newRol;
  let newEstado;
  let oldRol;
  let oldEstado;
  let referencia;
  let idUser;
  let docUserMod;
  let cambios = [];
  let representante;
  let spa;

  function saveDateMod(responsable, usuarioMod, fechaMod, descripcion) {
    db.collection('Modificaciones').doc().set({ responsable, usuarioMod, fechaMod, descripcion });
  }

  async function getPlanesUsers(numerodocumento) {
    return await getDataByData("PlanesUsuarios", 'numerodocumento', numerodocumento);
  }

  function getFirstPosDocument(doc) {
    let firstPos;
    doc.forEach(doc => {
      firstPos = doc.data();
    });
    return firstPos;
  }

  function drawPlanes(planes, numerodocumento) {
    tablePlanes.innerHTML = '';
    planes.forEach(plan => {
      tablePlanes.innerHTML += '<tr><td  >' + plan.data()['termino'] + '</td><td >' + plan.data()['plan'] + '</td><td >' + plan.data()['fechaPago'] + '</td><td > ' + plan.data()['valorPlan'] + ' </td><td > ' + plan.data()['numContrato'] + ' </td><td >' + plan.data()['referencia'] + '</td> <td ><button class ="btn btn-secondary  btnSearchRecibo" data-image = "' + numerodocumento + plan.data()['referencia'] + '"> Ver</button></td><td ><input type="checkbox" class="form-check-input" ></td></tr>';
    });
  }

  function drawUsers(data, datos, docid) {
    let idRef;
    let user;
    let planes;
    let repre;
    let spaPorAd;
    let spaDir;
    let spaIndir;
    tableUsers.innerHTML += '<tr> <td>' + data['nombre'] + '</td><td>' + data['apellido'] + '</td><td>' + data['numerodocumento'] + '</td><td>' + data['patrocinador'] + '</td><td>' + datos['estadoPago'] + '</td><td>' + datos['fechaPago'] + '</td><td>' + datos['recibo'] + '</td> <td><button class ="btn btn-primary  btnSearchUser" data-id = "' + docid + '">Ver Usuario</button></td> </tr>';
    const btnSearchUser = document.querySelectorAll('.btnSearchUser');
    btnSearchUser.forEach(async btn => {
      btn.addEventListener('click', async (e) => {
        containerUserForm.style.display = "block";
        const doc = await getUser(e.target.dataset.id);
        const divSpaPorAd = document.getElementById('spaPorAd');
        const divSpaDirectos = document.getElementById('spaDirectos');
        const divSpaIndirectos = document.getElementById('spaIndirectos');
        user = doc.data();
        idRef = user['idref'];
        idUser = doc.id;
        docUserMod = user['numerodocumento'];
        planes = await getPlanesUsers(user['numerodocumento']);
        drawPlanes(planes, user['numerodocumento']);
        datos = await getDataByData("Users", 'usuario', user['patrocinador']);
        repre = getFirstPosDocument(datos);
        representante = repre['nombre'] + ' ' + repre['apellido'];
        showUser(user);
        spaPorAd = await getSPA(user['numerodocumento']);
        spaDir = await getIdRef(idRef, 'idReferidoDirecto', 'tableRefDirect');
        spaIndir = await getIdRef(idRef, 'idReferidoIndirecto', 'tableRefInirect');
        divSpaPorAd.innerHTML = '<h3 class="titleTable">' + spaPorAd + '</h3>';
        divSpaDirectos.innerHTML = '<h3 class="titleTable">' + spaDir + '</h3>';
        divSpaIndirectos.innerHTML = '<h3 class="titleTable">' + spaIndir + '</h3>';
        const btnSearchRecibo = document.querySelectorAll('.btnSearchRecibo');
        btnSearchRecibo.forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            getUrlImage('reciboPago' + e.target.dataset.image);
          });
        });
      });
    });
  }

  function getUsers() {
    onGetUsers((querySnapshot) => {
      tableUsers.innerHTML = '';
      querySnapshot.forEach(async doc => {
        let data = doc.data();
        let planesUser = await getPlanesUsers(data['numerodocumento']);
        let datos = getFirstPosDocument(planesUser);
        if (data['estado']) {
          setTimeout(drawUsers(data, datos, doc.id), 1000);
        }
      });
    });
  }



  btnCerrar.addEventListener('click', function () {
    containerUserForm.style.display = "none";
    formUser.reset();
    tablePlanes.innerHTML = '';
  });

  btnDocument.addEventListener('click', (e) => {
    getUrlImage('cedula' + formUser['inputTipoDoc'].value);
  });

  btnRespaldo.addEventListener('click', (e) => {
    getUrlImage('Respaldocedula' + formUser['inputTipoDoc'].value);
  });

  btnSelfie.addEventListener('click', (e) => {
    getUrlImage('selfi' + formUser['inputTipoDoc'].value);
  });

  btnRecibo.addEventListener('click', (e) => {
    getUrlImage('recibo' + formUser['inputTipoDoc'].value);
  });

  flexRadioRol1.addEventListener('change', (e) => {
    newRol = 'usuario';
  });

  flexRadioRol2.addEventListener('change', (e) => {
    newRol = 'inversionista';
  });

  flexRadioRol3.addEventListener('change', (e) => {
    newRol = 'representante';
  });

  flexRadioRol4.addEventListener('change', (e) => {
    newRol = 'financiero';
  });

  flexRadioRol5.addEventListener('change', (e) => {
    newRol = 'juridico';
  });

  flexRadioRol6.addEventListener('change', (e) => {
    newRol = 'comercial';
  });

  flexRadioStatus1.addEventListener('change', (e) => {
    newEstado = true;
  });

  flexRadioStatus2.addEventListener('change', (e) => {
    newEstado = false;
  });



  function updateRol(rol, dateMod) {
    cambios[0] = 'Se cambio el rol a: ' + rol + ' del usuario con cédula: ' + formUser['inputTipoDoc'].value;
    updateUser(idUser, {
      rol: rol,
      fechaMod: dateMod
    });
  }
  function updateStatus(status, dateMod) {
    cambios[1] = 'Se cambio el estado a: ' + status + ' del usuario con cédula: ' + formUser['inputTipoDoc'].value;
    updateUser(idUser, {
      estado: status,
      fechaMod: dateMod
    });
  }

  function rolUser(rol) {
    if (rol == 'usuario') {
      $('#flexRadioRol1').prop("checked", true);
    }
    if (rol == 'inversionista') {
      $('#flexRadioRol2').prop("checked", true);
    }
    if (rol == 'representante') {
      $('#flexRadioRol3').prop("checked", true);
    }
    if (rol == 'financiero') {
      $('#flexRadioRol4').prop("checked", true);
    }
    if (rol == 'juridico') {
      $('#flexRadioRol5').prop("checked", true);
    }
    if (rol == 'comercial') {
      $('#flexRadioRol6').prop("checked", true);
    }
  }

  function statusUser(status) {
    if (status == true) {
      $('#flexRadioStatus1').prop("checked", true);
    }
    if (status == false) {
      $('#flexRadioStatus2').prop("checked", true);
    }
  }

  function showUser(user) {
    formUser['inputName'].value = user['nombre'] + ' ' + user['apellido'];
    $('#spanTipoDoc').text(user['tipodocumento']);
    formUser['inputTipoDoc'].value = user['numerodocumento'];
    formUser['inputRepresentante'].value = representante;
    formUser['inputEmail'].value = user['correo'];
    formUser['inputDateRegister'].value = user['fechaRegistro'];
    formUser['inputNumber'].value = user['numero'];
    formUser['inputCiudad'].value = user['ciudad'];
    formUser['inputIdReferido'].value = user['idref'];
    formUser['inputUsuario'].value = user['usuario'];
    getUserxIdRef(user['idReferidoDirecto'])
    rolUser(user['rol']);
    statusUser(user['estado']);
    newRol = user['rol'];
    newEstado = user['estado'];
    oldRol = user['rol'];
    oldEstado = user['estado'];
  }

  function getUrlImage(nameImage) {
    let token = "";
    $.ajax({
      url: "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage,
      type: "GET",
      success: function (data) {
        token = data.downloadTokens;
        urli = "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage + "?alt=media&token=" + token;
        window.open(urli, "Diseño Web");
      },
      error: function () {
        alert('No hay un recibo para este portafolio');
      }
    });
  }

  async function getUserxIdRef(idRef) {
    const users = await getDataByData("Users", "idref", idRef);
    users.forEach(user => {
      formUser['inputRefPor'].value = user.data()['nombre'] + ' ' + user.data()['apellido'];
    });
  }

  //Obtener los usuarios referidos del usuario con la variable spa
  async function getIdRef(idRef, tipo, tabla) {
    let spaGeneral = 0;
    let spa;
    let users = await getDataByData("Users", tipo, idRef);
    const tableRef = document.getElementById(tabla);
    tableRef.innerHTML = '';
    users.forEach(async doc => {
      let referidos = doc.data();
      spa = await getSPA(referidos['numerodocumento']);
      spaGeneral += spa;
      tableRef.innerHTML += '<tr><td>' + referidos['idref'] + '</td><td>' + spa + '</td></tr>';
    });
    console.log(spaGeneral);
    return spaGeneral;
  }

  //Obtener variable SPA
  async function getSPA(numDoc) {
    let datos = await getPlanesUsers(numDoc);
    let spa = 0;
    datos.forEach(doc => {
      spa += doc.data()['valorPlan'];
    });
    return spa;
  }


  //Evento de formulario para guardar cambios de los usuarios
  formLogIn.addEventListener('submit', (e) => {
    e.preventDefault();
    let idUser = '';
    let doc;
    let statusQuery;
    db.collection("Users").where('usuario', "==", formLogIn['inputUser'].value)
      .get()
      .then(function (querySnapshot) {
        querySnapshot.forEach(function (dat) {
          doc = dat.data();
          idUser = dat.id;
        });
      })
      .catch(function (error) {
        console.log("Error getting documents: ", error);
      });
    $('#modalAuth').modal('hide')
    setTimeout(function () {
      statusQuery = existUser(idUser, doc);
    }, 1000);
    setTimeout(function () {
      statusQueryFun(statusQuery);
    }, 1200);

  });

  //Verificar si la respuesta de los cambios es true
  function statusQueryFun(statusQuery) {
    if (statusQuery) {
      location.reload(true);
    } else {
      alert('No se pudieron realizar los cambios');
    }
  }

  //Autenticar usuario para guardar cambios
  function existUser(idResponsable, doc) {
    let statusQuery;
    let dateMod = getDate();
    hashUserPass = hashPassword();
    if (idResponsable != '' && doc['password'] == hashUserPass) {
      if (doc['rol'] != 'usuario' && doc['rol'] != 'inversionista') {
        if (newRol != oldRol) {
          updateRol(newRol, dateMod);
          saveDateMod(doc['numerodocumento'], docUserMod, dateMod, cambios[0]);
        }
        if (newEstado != oldEstado) {
          updateStatus(newEstado, dateMod);
          saveDateMod(doc['numerodocumento'], docUserMod, dateMod, cambios[1]);
        }
        alert('Se guardo la información correctamente ');
        statusQuery = true;
      } else {
        alert('No tienes permisos para modificar los datos');
        statusQuery = false;
      }
    } else {
      alert('Los datos ingresados no son correctos');
      statusQuery = false;
    }
    return statusQuery;
  }

  //Funcion de encriptar contraseñas
  function hashPassword() {
    let passwordHash = CryptoJS.SHA256(formLogIn['inputPassword'].value);
    return passwordHash.toString(CryptoJS.enc.Base64);
  }

  //funcion de obtener la  fecha
  function getDate() {
    var currentdate = new Date();
    var datetime = currentdate.getDate() + "/"
      + (currentdate.getMonth() + 1) + "/"
      + currentdate.getFullYear() + " @ "
      + currentdate.getHours() + ":"
      + currentdate.getMinutes() + ":"
      + currentdate.getSeconds();
    return datetime;
  }

</script>



</html>