<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>

</head>

<body>
  <div class="container" style="margin-top: 10px;">
    <div class="container" id="containerLogIn">
      <div class="row justify-content-center">
        <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12"></div>
        <div class="card text-center" style="width: 450px;">
          <div class="card-header">
            <h3>Log in</h3>
          </div>
          <div class="card-body">
            <form id="formLogIn">
              <div class="row">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="input-group mb-3"></div>
                  <input type="text" placeholder="Usuario" class="form-control" id="inputUser" required>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                  <div class="input-group mb-3"></div>
                  <input type="password" name="password" id="inputPassword" placeholder="Contraseña"
                    class="form-control" required>
                </div>
              </div>
            
          </div>
          <div class="card-footer text-muted">
            <button class="btn btn-primary" id="btnLogIn" type="submit"> Iniciar Sesión </button>
          </div>
        </form>
        </div>
      </div>
    </div>


    <div class="" style="margin-top: 20px; margin-bottom: 40px; display: none;  " id="containerUserForm">
      
      <div class="row col-md-12  justify-content-center">
        <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
<div class="alert alert-warning alert-dismissible fade show" role="alert">La sesión expira en
        <strong>15 minutos</strong>.
      </div><div class="card text-center">
          <div class="card-header">
            <h4 style="
            font-size: 20px;
            margin-bottom: 0px;
            margin-top: 0px;
        ">Perfil de Usuario</h4>
          </div>
          <div class="card-body">
            <form class="col-md-12" id="formUser">
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Nombre Completo</span>
                    <input type="text" class="form-control" id="inputName" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="spanTipoDoc"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Cedula</span>
                    <input type="text" class="form-control" id="inputTipoDoc" aria-describedby="spanTipoDoc" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Representante</span>
                    <input type="text" class="form-control" id="inputRepresentante" aria-describedby="basic-addon3"
                      value="" disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Correo Electronico</span>
                    <input type="text" class="form-control" id="inputEmail" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Fecha Registro</span>
                    <input type="text" class="form-control" id="inputDateRegister" aria-describedby="basic-addon3"
                      value="" disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Número</span>
                    <input type="text" class="form-control" id="inputNumber" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
              </div>

              <div class="row " style="text-align: center;">
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px; border-bottom-right-radius: 0px;">Rol</span>
                    <input type="text" class="form-control" id="inputRol" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
                <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-6">
                  <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon3"
                      style="border-top-right-radius: 0px;  border-bottom-right-radius: 0px;">Estado</span>
                    <input type="text" class="form-control" id="inputStatus" aria-describedby="basic-addon3" value=""
                      disabled>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table id="tablePlan" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
                  <thead>
                    <tr>
                      <th class="th-sm">Plazo
                      </th>
                      <th class="th-sm">Plan
                      </th>
                      <th class="th-sm">Fecha compra
                      </th>
                      <th class="th-sm">Ver Recibo
                      </th>
                    </tr>
                  </thead>
                  <tbody id="tablePlanes">
                  </tbody>
                  <tr>
                    <th>Plazo
                    </th>
                    <th>Plan
                    </th>
                    <th>Fecha compra
                    </th>
                    <th>Ver Recibo
                    </th>
                  </tr>
                  <tfoot>
                  </tfoot>
                </table>
                <div class="row justify-content-center" style="margin-top: 30px; margin-left: -35px;">
                  <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                    <div class="btn-group me-2 " role="group" aria-label="Second group">
                      <button type="button" class="btn btn-secondary btn-sm" id="btnDocument">Documento</button>
                      <button type="button" class="btn btn-secondary btn-sm" id="btnRespaldo">Respaldo</button>
                      <button type="button" class="btn btn-secondary btn-sm" id="btnSelfie">Selfie</button>
                      <button type="button" class="btn btn-secondary btn-sm" id="btnRecibo">Recibo Domicilio</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="card-footer text-muted">
            <div class="row justify-content-center">
              <div class="col col-md-12 col-12 col-sm-12 col-lg-12 col-xl-12">
                <button type="button" class="btn btn-warning" id="btnCerrar">Cerrar</button>
              </div>
            </div>
          </div>
        </div>
        </div>
        
      </div>
    </div>

  </div>
  </div>
</body>
<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.0.2/firebase-analytics.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>

<script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js">
</script>
<script>
  var firebaseConfig = {
    apiKey: "AIzaSyCPvLMdAYWqdYLAZK28AbBa56mIAo1JkxU",
    authDomain: "appfinancemarketscapital.firebaseapp.com",
    databaseURL: "https://appfinancemarketscapital.firebaseio.com",
    projectId: "appfinancemarketscapital",
    storageBucket: "gs://appfinancemarketscapital.appspot.com",
    messagingSenderId: "327823603780",
    appId: "1:327823603780:web:506199709abac99322a411",
    measurementId: "G-3V5TM2M89C"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const db = firebase.firestore();
  const dbStorage = firebase.storage().ref();

  $(document).ready(function () {
    //getUsers('91287753');

  });

  const tablePlanes = document.getElementById('tablePlanes');
  const containerUserForm = document.getElementById('containerUserForm');
  const containerLogIn = document.getElementById('containerLogIn');
  const updateUser = (id, updateUser) => db.collection('Users').doc(id).update(updateUser);
  const getUser = (id) => db.collection("Users").doc(id).get();
  const formUser = document.getElementById('formUser');
  const formLogIn = document.getElementById('formLogIn');
  const btnCerrar = document.getElementById('btnCerrar');
  const btnLogIn = document.getElementById('btnLogIn');
  const btnDocument = document.getElementById('btnDocument');
  const btnRespaldo = document.getElementById('btnRespaldo');
  const btnSelfie = document.getElementById('btnSelfie');
  const btnRecibo = document.getElementById('btnRecibo');

  async function getUsers(idUser, numDoc) {
    containerUserForm.style.display = "block";
    const doc = await getUser(idUser);
    let user = doc.data();
    let planes;
    showUser(user);
    db.collection("PlanesUsuarios").where('numerodocumento', "==", numDoc)
      .get()
      .then(function (querySnapshot) {
        querySnapshot.forEach(function (dat) {
          planes = dat.data();
        });
      })
      .catch(function (error) {
        console.log("Error getting documents: ", error);
      });
    setTimeout(function () {
      tablePlanes.innerHTML = '';
      tablePlanes.innerHTML += '<tr><td>' + planes['termino'] + '</td><td>' + planes['plan'] + '</td><td>' + planes['fechaPago'] + '</td> <td><button class ="btn btn-secondary  btnSearchRecibo" data-image = "' + user['numerodocumento'] + planes['referencia'] + '">Ver Recibo</button></td></tr>';
      const btnSearchRecibo = document.querySelectorAll('.btnSearchRecibo');
      btnSearchRecibo.forEach(btn => {
        btn.addEventListener('click', (e) => {
          console.log(e.target.dataset.nameImage);
          e.preventDefault();
          planes['referencia'] == 'Pendiente' ? alert('No hay un recibo para este portafolio') : getUrlImage('reciboPago' + e.target.dataset.image);
        });
      });
    }, 1000);
  }

  formLogIn.addEventListener('submit', (e) => {
    e.preventDefault();
    let idUser = '';
    let doc;
    db.collection("Users").where('usuario', "==", formLogIn['inputUser'].value)
      .get()
      .then(function (querySnapshot) {
        querySnapshot.forEach(function (dat) {
          doc = dat.data();
          idUser = dat.id;
        });
      })
      .catch(function (error) {
        console.log("Error getting documents: ", error);
      });

    setTimeout(function () {
      existUser(idUser, doc);
    }, 1000);
  })

  function existUser(idUser, doc) {
    hashUserPass = hashPassword();
    if (idUser != '' && doc['password'] == hashUserPass) {
      containerUserForm.style.display = "block";
      containerLogIn.style.display = "none";
      getUsers(idUser, doc['numerodocumento']);
      setTimeout(function(){
        reloadWindows();
      },900000);
    } else {
      alert('Los datos ingresados no son correctos');
    }
  }

  function hashPassword() {
    let passwordHash = CryptoJS.SHA256(formLogIn['inputPassword'].value);
    return passwordHash.toString(CryptoJS.enc.Base64);
  }

  btnDocument.addEventListener('click', (e) => {
    getUrlImage('cedula' + formUser['inputTipoDoc'].value);
  });

  btnRespaldo.addEventListener('click', (e) => {
    getUrlImage('Respaldocedula' + formUser['inputTipoDoc'].value);
  });

  btnSelfie.addEventListener('click', (e) => {
    getUrlImage('selfi' + formUser['inputTipoDoc'].value);
  });

  btnRecibo.addEventListener('click', (e) => {
    getUrlImage('recibo' + formUser['inputTipoDoc'].value);
  });

  btnCerrar.addEventListener('click', (e)=>{
    location.reload(true);
  });

  function reloadWindows(){
    alert('La sesión ha expirado');
    location.reload(true);
  }


  function showUser(user) {
    formUser['inputName'].value = user['nombre'] + ' ' + user['apellido'];
    $('#spanTipoDoc').text(user['tipodocumento']);
    formUser['inputTipoDoc'].value = user['numerodocumento'];
    formUser['inputRepresentante'].value = user['patrocinador'];
    formUser['inputEmail'].value = user['correo'];
    formUser['inputDateRegister'].value = user['fechaRegistro'];
    formUser['inputNumber'].value = user['numero'];
    formUser['inputRol'].value = user['rol'];
    user['estado'] == true ? formUser['inputStatus'].value = 'Activo' : formUser['inputStatus'].value = 'Inactivo';
  }

  function getUrlImage(nameImage) {
    let token;
    $.ajax({
      url: "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage,
      type: "GET"
    }).done(function (data) {
      token = data.downloadTokens;
    });
    urli = "https://firebasestorage.googleapis.com/v0/b/appfinancemarketscapital.appspot.com/o/imagenes%2F" + nameImage + "?alt=media&token=" + token;
    window.open(urli, "Diseño Web")
  }


</script>



</html>